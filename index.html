<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Three.js Game with Sounds</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #f0f0f0);
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #score, #gameOver {
            position: absolute;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        #score {
            top: 20px;
        }

        #gameOver {
            top: 50px;
            font-size: 48px;
            display: none;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #gameOver.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* Style for the YouTube iframe */
        #youtubePlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Prevent interaction with the iframe */
            z-index: -1; /* Place behind the game canvas */
        }
    </style>
</head>
<body>
<div id="score">Score: 0</div>
<div id="gameOver">Game Over</div>

<!-- YouTube iframe player -->
<div id="youtubePlayer">
    <iframe id="youtubeIframe" src="https://www.youtube.com/embed/1rkUcw9INLI?enablejsapi=1&mute=1&autoplay=1&loop=1&playlist=1rkUcw9INLI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script>
    let scene, camera, renderer, player, obstacles = [], collectibles = [];
    let controls;
    let scoreText = document.getElementById('score');
    let gameOverText = document.getElementById('gameOver');
    let youtubeIframe = document.getElementById('youtubeIframe').contentWindow; // Access the iframe's window
    let gameSpeed = 0.1;
    let moveLeft = false, moveRight = false;
    let isGameOver = false;
    let score = 0;
    const obstacleColors = [0xff0000, 0x0000ff, 0xffff00];
    const collectibleColor = 0xffff00;
    const chineseCharacters = ['你', '好', '我', '是', '学', '习', '三', '维', '空', '间'];

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);

        let geometry = new THREE.BoxGeometry(1, 1, 1);
        let material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        player = new THREE.Mesh(geometry, createRandomTexture());
        player.position.z = -5;
        scene.add(player);

        let groundGeometry = new THREE.PlaneGeometry(20, 1000);
        let groundMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        let ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1;
        scene.add(ground);

        // Start playing random segments from the YouTube video
        playRandomSegment();

        for (let i = 0; i < 10; i++) {
            createObstacle();
            createCollectible();
        }

        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);
        animate();
    }

    function createRandomTexture() {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 256;

        context.fillStyle = 'white';
        context.fillRect(0, 0, canvas.width, canvas.height);
        context.fillStyle = 'black';
        context.font = '70px Arial';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        context.fillText(chineseCharacters[Math.floor(Math.random() * chineseCharacters.length)], canvas.width / 2, canvas.height / 2);

        return new THREE.MeshStandardMaterial({ map: new THREE.CanvasTexture(canvas) });
    }

    function createObstacle() {
        let obstacleGeometry = new THREE.BoxGeometry(1, 1, 1);
        let obstacleMaterial = createRandomTexture();
        let obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial);

        obstacle.position.x = Math.random() * 6 - 3;
        obstacle.position.z = Math.random() * -50 - 10;

        obstacles.push(obstacle);
        scene.add(obstacle);
    }

    function createCollectible() {
        let collectibleGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        let collectibleMaterial = new THREE.MeshStandardMaterial({ color: collectibleColor });
        let collectible = new THREE.Mesh(collectibleGeometry, collectibleMaterial);

        collectible.position.x = Math.random() * 6 - 3;
        collectible.position.z = Math.random() * -50 - 10;

        collectibles.push(collectible);
        scene.add(collectible);
    }

    function animate() {
        if (isGameOver) return;

        requestAnimationFrame(animate);

        const playerSpeed = 0.2;
        if (moveLeft && player.position.x > -3) {
            player.position.x -= playerSpeed;
        }
        if (moveRight && player.position.x < 3) {
            player.position.x += playerSpeed;
        }

        obstacles.forEach(obstacle => {
            obstacle.position.z += gameSpeed;
            if (obstacle.position.distanceTo(player.position) < 1) {
                gameOver();
            }
            if (obstacle.position.z > camera.position.z) {
                obstacle.position.z = Math.random() * -50 - 10;
                obstacle.position.x = Math.random() * 6 - 3;
            }
        });

        collectibles.forEach((collectible, index) => {
            collectible.position.z += gameSpeed;
            if (collectible.position.distanceTo(player.position) < 0.75) {
                score += 10;
                scoreText.innerHTML = "Score: " + score;
                scene.remove(collectible);
                collectibles.splice(index, 1);
                createCollectible();
            }
            if (collectible.position.z > camera.position.z) {
                collectible.position.z = Math.random() * -50 - 10;
                collectible.position.x = Math.random() * 6 - 3;
            }
        });

        controls.update();
        renderer.render(scene, camera);
    }

    function onKeyDown(event) {
        switch (event.key) {
            case 'ArrowLeft':
                moveLeft = true;
                break;
            case 'ArrowRight':
                moveRight = true;
                break;
        }
    }

    function onKeyUp(event) {
        switch (event.key) {
            case 'ArrowLeft':
                moveLeft = false;
                break;
            case 'ArrowRight':
                moveRight = false;
                break;
        }
    }

    function gameOver() {
        isGameOver = true;
        gameOverText.classList.add('show');
        gameOverText.innerHTML = "Game Over<br>Your Score: " + score;
        document.getElementById('crashSound').play();
        document.getElementById('backgroundMusic').pause();
    }

    function playRandomSegment() {
        const randomTime = Math.floor(Math.random() * 300) * 1000; // Random time between 0 and 300 seconds
        youtubeIframe.postMessage(JSON.stringify({
            event: 'command',
            func: 'seekTo',
            args: [randomTime, true]
        }), '*');

        // Play the video
        youtubeIframe.postMessage(JSON.stringify({
            event: 'command',
            func: 'playVideo',
            args: []
        }), '*');

        setTimeout(playRandomSegment, 5000); // Change segment every 5 seconds
    }

    window.addEventListener('resize', function () {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
</script>
</body>
</html>
